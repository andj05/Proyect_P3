@{
    ViewBag.Title = "Marcas";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Solo CSS en el HEAD -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.32/sweetalert2.min.css" rel="stylesheet">

<style>
    .page-container {
        background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
        min-height: 100vh;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
    }

    .header-card {
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        color: white;
        border-radius: 0;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        padding: 2rem;
        margin-bottom: 0;
        position: relative;
        overflow: hidden;
    }

        .header-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><pattern id="brand-pattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M2 10 L8 10 L10 8 L14 8 L16 10 L18 10" stroke="rgba(255,255,255,0.1)" stroke-width="1" fill="none"/></pattern></defs><rect width="100" height="20" fill="url(%23brand-pattern)"/></svg>') repeat;
            opacity: 0.1;
            z-index: 1;
        }

    .header-content {
        position: relative;
        z-index: 2;
    }

    .page-title {
        color: white;
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
    }

    .brand-icon {
        background: rgba(255, 255, 255, 0.2);
        padding: 12px;
        border-radius: 50%;
        margin-right: 15px;
        font-size: 1.5rem;
    }

    .subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 1.5rem;
    }

    .btn-modern {
        border-radius: 25px;
        font-weight: 600;
        padding: 12px 30px;
        transition: all 0.3s ease;
        border: none;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 1rem;
        display: inline-block;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-marcas {
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        color: white;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
    }

        .btn-marcas:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.6);
            color: white;
        }

    .btn-secondary-modern {
        background: linear-gradient(135deg, #6c757d, #495057);
        color: white;
        box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
    }

        .btn-secondary-modern:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.5);
            color: white;
        }

    .stats-info {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        color: white;
        padding: 1.5rem;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stats-number {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .stats-label {
        font-size: 1.1rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .table-container {
        width: 100%;
        padding: 0;
        margin: 0;
        background: white;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .table-modern {
        width: 100%;
        margin: 0;
        border: none;
        background: white;
        border-radius: 0;
        overflow: hidden;
        height: 100%;
        flex: 1;
    }

        .table-modern thead th {
            background: linear-gradient(135deg, #1a1a1a, #2c2c2c);
            color: white;
            font-weight: 700;
            padding: 1.5rem 1rem;
            border: none;
            text-align: center;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table-modern tbody tr {
            transition: all 0.3s ease;
            border: none;
        }

            .table-modern tbody tr:hover {
                background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(59, 130, 246, 0.05));
                transform: scale(1.01);
            }

        .table-modern tbody td {
            padding: 1.5rem 1rem;
            border: none;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
            text-align: center;
            word-wrap: break-word;
            min-height: 80px;
        }

        .table-modern tbody tr:last-child td {
            border-bottom: none;
        }

    .dataTables_wrapper {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .dataTables_scroll {
        flex: 1;
    }

    .dataTables_scrollBody {
        min-height: 400px;
    }

    .dataTables_empty {
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(59, 130, 246, 0.05)) !important;
        color: #666 !important;
        font-size: 1.2rem !important;
        padding: 3rem !important;
        text-align: center !important;
    }

        .dataTables_empty:before {
            content: "🏷️ ";
            font-size: 2rem;
            display: block;
            margin-bottom: 1rem;
        }

    .btn-action {
        border-radius: 20px;
        padding: 10px 20px;
        font-size: 0.9rem;
        font-weight: 600;
        margin: 4px;
        transition: all 0.3s ease;
        border: none;
        display: inline-block;
        text-transform: uppercase;
    }

    .btn-edit-marcas {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

        .btn-edit-marcas:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.5);
            color: white;
        }

    .btn-delete-marcas {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

        .btn-delete-marcas:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.5);
            color: white;
        }

    .marca-id {
        color: #2563eb;
        font-weight: 700;
        font-size: 1.2rem;
    }

    .marca-descripcion {
        color: #2c2c2c;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-active {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .status-inactive {
        background: linear-gradient(135deg, #6c757d, #495057);
        color: white;
        box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
    }

    .actions-buttons {
        margin-bottom: 1.5rem;
        padding-top: 1rem;
    }

    .image-preview {
        max-width: 120px;
        max-height: 100px;
        border-radius: 10px;
        border: 3px solid #2563eb;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-content {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .spinner-marcas {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #2563eb;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    body {
        margin: 0;
        padding: 0;
    }

    .container.body-content {
        padding: 0 !important;
        margin: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
    }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
        background: #f8f9fa;
        padding: 1rem;
        margin: 0;
    }

    .dataTables_wrapper .dataTables_length {
        border-bottom: 1px solid #e9ecef;
    }

    .dataTables_wrapper .dataTables_filter {
        border-bottom: 1px solid #e9ecef;
        text-align: right;
    }

        .dataTables_wrapper .dataTables_filter input {
            border-radius: 20px;
            border: 2px solid #2563eb;
            padding: 8px 15px;
            margin-left: 0.5rem;
        }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: linear-gradient(135deg, #2563eb, #3b82f6) !important;
        border: none !important;
        color: white !important;
        border-radius: 5px !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: linear-gradient(135deg, #2563eb, #3b82f6) !important;
        border: none !important;
        color: white !important;
    }

    .debug-panel {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        z-index: 10000;
        max-width: 300px;
        display: none;
    }

    .no-data-placeholder {
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(59, 130, 246, 0.05));
        padding: 4rem 2rem;
        text-align: center;
        border-radius: 15px;
        margin: 2rem;
    }

        .no-data-placeholder i {
            font-size: 4rem;
            color: #2563eb;
            margin-bottom: 1rem;
        }
</style>

<div class="page-container">
    <!-- Header con información y botones -->
    <div class="header-card">
        <div class="header-content">
            <h2 class="page-title">
                <span class="brand-icon"><i class="fas fa-tags"></i></span>
                Marcas Anddy Motors
            </h2>
            <p class="subtitle">Gestiona Toyota, Ford, BMW, Mercedes-Benz y todas las marcas de tu concesionario premium</p>

            <div class="stats-info">
                <div class="stats-number" id="marcasCount">0</div>
                <div class="stats-label">Marcas Registradas</div>
            </div>

            <div class="actions-buttons">
                <button type="button" class="btn btn-modern btn-marcas" data-bs-toggle="modal" data-bs-target="#modalMarcas">
                    <i class="fas fa-plus me-2"></i>Nueva Marca
                </button>
                <input type="button"
                       value="Volver Atrás"
                       class="btn btn-modern btn-secondary-modern"
                       onclick="document.location.href='@Url.Content("~/")'" />
                <button type="button" class="btn btn-modern btn-secondary-modern" onclick="testConexion()">
                    <i class="fas fa-database me-2"></i>Test Conexión
                </button>
                <button type="button" class="btn btn-modern btn-secondary-modern" onclick="toggleDebug()">
                    <i class="fas fa-bug me-2"></i>Debug
                </button>
                <button type="button" class="btn btn-modern btn-secondary-modern" onclick="cargarMarcasSimple()">
                    <i class="fas fa-sync me-2"></i>Recargar
                </button>
            </div>
        </div>
    </div>

    <!-- Tabla de pantalla completa -->
    <div class="table-container">
        <table class="table table-modern" id="tablaMarcas">
            <thead>
                <tr>
                    <th><i class="fas fa-image me-2"></i>Imagen</th>
                    <th><i class="fas fa-tag me-2"></i>Descripción</th>
                    <th><i class="fas fa-toggle-on me-2"></i>Estado</th>
                    <th><i class="fas fa-cogs me-2"></i>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be loaded via AJAX -->
            </tbody>
        </table>

        <!-- Placeholder cuando no hay datos -->
        <div class="no-data-placeholder d-none" id="noDataPlaceholder">
            <i class="fas fa-tags"></i>
            <h3>¡Comienza a gestionar tus marcas!</h3>
            <p>No tienes marcas registradas aún. Haz clic en "Nueva Marca" para agregar tu primera Toyota, Ford, BMW o cualquier otra marca.</p>
            <button type="button" class="btn btn-marcas mt-3" data-bs-toggle="modal" data-bs-target="#modalMarcas">
                <i class="fas fa-plus me-2"></i>Agregar Primera Marca
            </button>
        </div>
    </div>
</div>

<!-- Panel de Debug -->
<div class="debug-panel" id="debugPanel">
    <div id="debugContent">Debug activo...</div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner-marcas"></div>
        <p>Cargando marcas...</p>
    </div>
</div>

<!-- Modal para Marcas -->
<div class="modal fade" id="modalMarcas" tabindex="-1" aria-labelledby="modalMarcasLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #2563eb, #3b82f6); color: white;">
                <h5 class="modal-title" id="modalMarcasLabel">
                    <i class="fas fa-tags me-2"></i>Gestión de Marca
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formMarcas">
                    <input type="hidden" id="txtIdMarca" value="0">

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="txtDescripcion" class="form-label">
                                <i class="fas fa-tag me-2"></i>Descripción de la Marca
                            </label>
                            <input type="text" class="form-control" id="txtDescripcion" placeholder="Ej: Toyota, Ford, BMW, Mercedes-Benz..." required>
                            <div class="form-text">Especifica el nombre de la marca del vehículo</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fileImagen" class="form-label">
                                <i class="fas fa-image me-2"></i>Logo de la Marca
                            </label>
                            <input type="file" class="form-control" id="fileImagen" accept="image/*">
                            <div class="form-text">Selecciona el logo oficial de la marca</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Vista previa</label>
                            <div id="imagePreview" class="text-center">
                                <img id="previewImg" class="image-preview" style="display: none;" alt="Vista previa">
                                <p class="text-muted" id="noImageText">Sin imagen seleccionada</p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="selectEstatus" class="form-label">
                                <i class="fas fa-toggle-on me-2"></i>Estado
                            </label>
                            <select class="form-select" id="selectEstatus">
                                <option value="true">Activo</option>
                                <option value="false">Inactivo</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-marcas" id="btnGuardar">
                    <i class="fas fa-save me-2"></i>Guardar Marca
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS AL FINAL - ORDEN CRÍTICO -->
<!-- 1. jQuery PRIMERO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- 2. Bootstrap -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<!-- 4. SweetAlert2 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.32/sweetalert2.min.js"></script>

<!-- 5. Nuestro código JavaScript AL FINAL -->
<script>
    // Variables globales
    let debugMode = false;

    $(document).ready(function () {
        console.log('Document ready - cargando marcas...');
        cargarMarcasSimple();
        setupEventHandlers();
    });


function cargarMarcasSimple() {
    console.log('🔥 INICIANDO DIAGNÓSTICO COMPLETO...');

    // Verificar la URL que se está construyendo
    const url = '@Url.Action("ConsultaMarcas", "Marcas")';
    console.log('📍 URL construida:', url);
    console.log('🌐 URL completa que se va a llamar:', window.location.origin + url);

    debugLog('Enviando request de diagnóstico...');

    $.ajax({
        url: url,
        type: 'GET',
        dataType: 'json', // Asegurar que espere JSON
        cache: false, // Evitar cache
        success: function (response, textStatus, xhr) {
            console.log('✅ SUCCESS CALLBACK EJECUTADO');
            console.log('📊 Status HTTP:', xhr.status);
            console.log('📝 Text Status:', textStatus);
            console.log('🔍 Response Type:', typeof response);
            console.log('📦 Response completa:', response);

            debugLog('✅ Respuesta recibida exitosamente:', response);

            // Verificar estructura detalladamente
            if (response) {
                console.log('✅ Response existe');
                console.log('🔑 Response keys:', Object.keys(response));

                if (response.data) {
                    console.log('✅ response.data existe');
                    console.log('📊 Tipo de data:', typeof response.data);
                    console.log('📏 Longitud de data:', response.data.length);

                    if (Array.isArray(response.data)) {
                        console.log('✅ data es un array');

                        if (response.data.length > 0) {
                            console.log('✅ Array tiene elementos');
                            console.log('🎯 Primer elemento:', response.data[0]);
                            console.log('🔑 Keys del primer elemento:', Object.keys(response.data[0]));

                            // Verificar propiedades específicas del primer elemento
                            const primera = response.data[0];
                            console.log('🏷️ IdMarca:', primera.IdMarca);
                            console.log('📝 Descripcion:', primera.Descripcion);
                            console.log('🔄 Estatus:', primera.Estatus);
                            console.log('🖼️ Tiene ImagenBase64:', !!primera.ImagenBase64);
                            if (primera.ImagenBase64) {
                                console.log('📏 Longitud ImagenBase64:', primera.ImagenBase64.length);
                            }

                            // PROCEDER CON LA CARGA NORMAL
                            cargarDatosEnTabla(response.data);

                        } else {
                            console.log('❌ Array está vacío');
                            mostrarSinDatos();
                        }
                    } else {
                        console.log('❌ data NO es un array:', response.data);
                    }
                } else {
                    console.log('❌ response.data NO existe');
                    console.log('🔍 Propiedades disponibles:', Object.keys(response));
                }
            } else {
                console.log('❌ Response es null/undefined');
            }
        },
        error: function (xhr, status, error) {
            console.log('❌ ERROR CALLBACK EJECUTADO');
            console.log('📊 Status HTTP:', xhr.status);
            console.log('📝 Status Text:', xhr.statusText);
            console.log('🔍 Ready State:', xhr.readyState);
            console.log('📄 Response Text:', xhr.responseText);
            console.log('⚠️ Error Object:', error);
            console.log('🏷️ Status Parameter:', status);

            debugLog('❌ ERROR completo en AJAX:', {
                status: xhr.status,
                statusText: xhr.statusText,
                responseText: xhr.responseText,
                error: error
            });

            // Intentar parsear el responseText por si tiene información útil
            try {
                const parsedError = JSON.parse(xhr.responseText);
                console.log('📋 Error parseado:', parsedError);
            } catch (e) {
                console.log('⚠️ No se pudo parsear el error como JSON');
            }

            alert(`ERROR DETALLADO:
Status: ${xhr.status}
Status Text: ${xhr.statusText}
Error: ${error}
Response: ${xhr.responseText.substring(0, 200)}...`);
        },
        complete: function(xhr, status) {
            console.log('🏁 COMPLETE CALLBACK EJECUTADO');
            console.log('📊 Final Status:', status);
            console.log('📊 Final XHR Status:', xhr.status);
        }
    });
    }

    function cargarDatosEnTabla(marcas) {
    console.log('🎯 CARGANDO DATOS EN TABLA...');

    $('#marcasCount').text(marcas.length);
    let tbody = $('#tablaMarcas tbody');
    tbody.empty();

    marcas.forEach(function (marca, index) {
        console.log(`🏷️ Procesando marca ${index + 1}:`, marca);

        let imagenHtml = '';
        if (marca.ImagenBase64 && marca.ImagenBase64.length > 0) {
            imagenHtml = `<img src="data:image/jpeg;base64,${marca.ImagenBase64}"
                             width="60" height="60"
                             style="border-radius: 8px; object-fit: cover; border: 2px solid #2563eb;"
                             alt="Logo ${marca.Descripcion}"
                             onload="console.log('✅ Imagen cargada:', '${marca.Descripcion}')"
                             onerror="console.log('❌ Error cargando imagen:', '${marca.Descripcion}')">`;
        } else {
            imagenHtml = '<span class="text-muted"><i class="fas fa-image"></i> Sin imagen</span>';
        }

        let estatusHtml = marca.Estatus === true ?
            '<span class="status-badge status-active"><i class="fas fa-check me-1"></i>Activo</span>' :
            '<span class="status-badge status-inactive"><i class="fas fa-times me-1"></i>Inactivo</span>';

        let fila = `
            <tr>
                <td>${imagenHtml}</td>
                <td><span class="marca-descripcion">${marca.Descripcion || 'Sin descripción'}</span></td>
                <td>${estatusHtml}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-action btn-edit-marcas" onclick="editarMarca(${marca.IdMarca})">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button type="button" class="btn btn-action btn-delete-marcas" onclick="eliminarMarca(${marca.IdMarca})">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.append(fila);
    });

    $('#tablaMarcas').show();
    $('#noDataPlaceholder').addClass('d-none');

    console.log(`✅ ${marcas.length} marcas cargadas exitosamente en la tabla`);
}

function mostrarSinDatos() {
    $('#marcasCount').text('0');
    $('#tablaMarcas').hide();
    $('#noDataPlaceholder').removeClass('d-none');
    console.log('📭 Mostrando placeholder de sin datos');
}

// Función adicional para probar la URL directamente
function probarURLDirecta() {
    const url = '@Url.Action("ConsultaMarcas", "Marcas")';
    console.log('🧪 Probando URL directa:', url);

    fetch(url)
        .then(response => {
            console.log('🌐 Fetch Response Status:', response.status);
            console.log('🌐 Fetch Response OK:', response.ok);
            return response.text();
        })
        .then(text => {
            console.log('📄 Raw Response Text:', text);
            try {
                const json = JSON.parse(text);
                console.log('✅ Parsed JSON:', json);
            } catch (e) {
                console.log('❌ Error parsing JSON:', e);
            }
        })
        .catch(error => {
            console.log('❌ Fetch Error:', error);
        });
}

    function setupEventHandlers() {
        debugLog('Configurando event handlers...');

        // Preview de imagen
        $('#fileImagen').change(function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    $('#previewImg').attr('src', e.target.result).show();
                    $('#noImageText').hide();
                }
                reader.readAsDataURL(file);
            } else {
                $('#previewImg').hide();
                $('#noImageText').show();
            }
        });

        // Guardar marca
        $('#btnGuardar').click(function () {
            debugLog('Botón guardar clickeado');
            guardarMarca();
        });

        // Limpiar modal al cerrar
        $('#modalMarcas').on('hidden.bs.modal', function () {
            debugLog('Modal cerrado, limpiando campos...');
            limpiarModal();
        });
    }

    function guardarMarca() {
        debugLog('=== INICIANDO GUARDAR MARCA ===');

        let marca = {
            IdMarca: parseInt($('#txtIdMarca').val()) || 0,
            Descripcion: $('#txtDescripcion').val().trim(),
            Estatus: $('#selectEstatus').val() === 'true'
        };

        // Validaciones
        if (!marca.Descripcion) {
            Swal.fire({
                title: 'Error',
                text: 'La descripción es obligatoria',
                icon: 'error',
                confirmButtonColor: '#2563eb'
            });
            return;
        }

        // Capturar imagen si existe
        const fileInput = document.getElementById('fileImagen');
        if (fileInput.files && fileInput.files[0]) {
            const file = fileInput.files[0];
            debugLog('Archivo de imagen seleccionado:', { name: file.name, size: file.size, type: file.type });

            const reader = new FileReader();
            reader.onload = function (e) {
                const base64String = e.target.result.split(',')[1];
                marca.ImagenBase64 = base64String;
                debugLog('Imagen convertida a Base64, enviando datos...');
                enviarDatos(marca);
            };
            reader.readAsDataURL(file);
        } else {
            debugLog('No hay imagen seleccionada, enviando sin imagen...');
            enviarDatos(marca);
        }
    }

    function enviarDatos(marca) {
        debugLog('Datos de la marca a enviar:', marca);

        showLoading(true);
        debugLog('Enviando AJAX request...');

        $.ajax({
            url: '@Url.Action("InsertarMarcas", "Marcas")',
            type: 'POST',
            data: {
                'oMarca.IdMarca': marca.IdMarca,
                'oMarca.Descripcion': marca.Descripcion,
                'oMarca.Estatus': marca.Estatus,
                'ImagenBase64': marca.ImagenBase64 || null
            },
            success: function (response) {
                debugLog('Respuesta recibida:', response);
                showLoading(false);

                if (response && response.respuesta === true) {
                    debugLog('Marca guardada exitosamente');
                    Swal.fire({
                        title: 'Éxito',
                        text: 'Marca guardada correctamente',
                        icon: 'success',
                        confirmButtonColor: '#2563eb'
                    }).then(() => {
                        $('#modalMarcas').modal('hide');
                        cargarMarcasSimple(); // 🔥 RECARGAR AUTOMÁTICAMENTE
                    });
                } else {
                    debugLog('ERROR: Respuesta negativa del servidor', response);
                    Swal.fire({
                        title: 'Error',
                        text: response.error || 'No se pudo guardar la marca',
                        icon: 'error',
                        confirmButtonColor: '#2563eb'
                    });
                }
            },
            error: function (xhr, status, error) {
                debugLog('ERROR AJAX:', { xhr: xhr.responseText, status: status, error: error });
                showLoading(false);

                let errorMsg = 'Error de conexión';
                try {
                    let response = JSON.parse(xhr.responseText);
                    if (response.error) {
                        errorMsg = response.error;
                    }
                } catch (e) {
                    errorMsg = error || 'Error desconocido';
                }

                Swal.fire({
                    title: 'Error',
                    text: errorMsg,
                    icon: 'error',
                    confirmButtonColor: '#2563eb'
                });
            }
        });
    }

    function editarMarca(id) {
        debugLog('Editando marca con ID:', id);

        // Buscar la marca en los datos actuales
        showLoading(true);

        $.ajax({
            url: '@Url.Action("ConsultaMarcas", "Marcas")',
            type: 'GET',
            success: function (response) {
                showLoading(false);
                if (response && response.data) {
                    let marca = response.data.find(m => m.IdMarca == id);
                    if (marca) {
                        $('#txtIdMarca').val(marca.IdMarca);
                        $('#txtDescripcion').val(marca.Descripcion || '');
                        $('#selectEstatus').val(marca.Estatus ? 'true' : 'false');
                        $('#modalMarcas').modal('show');
                        debugLog('Datos cargados para edición:', marca);
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: 'No se encontró la marca a editar',
                            icon: 'error',
                            confirmButtonColor: '#2563eb'
                        });
                    }
                }
            },
            error: function (xhr, status, error) {
                showLoading(false);
                debugLog('ERROR al cargar marca para edición:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Error al cargar los datos de la marca',
                    icon: 'error',
                    confirmButtonColor: '#2563eb'
                });
            }
        });
    }

    function eliminarMarca(id) {
        debugLog('Intentando eliminar marca con ID:', id);

        Swal.fire({
            title: '¿Estás seguro?',
            text: 'Esta acción no se puede deshacer',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#2563eb',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                showLoading(true);
                debugLog('Enviando request de eliminación...');

                $.ajax({
                    url: '@Url.Action("BorrarMarcas", "Marcas")',
                    type: 'POST',
                    data: JSON.stringify({ idMarca: id }),
                    contentType: "application/json; charset=utf-8",
                    success: function (response) {
                        debugLog('Respuesta de eliminación:', response);
                        showLoading(false);
                        if (response && response.respuesta === true) {
                            debugLog('Marca eliminada exitosamente');
                            Swal.fire({
                                title: 'Eliminado',
                                text: 'Marca eliminada correctamente',
                                icon: 'success',
                                confirmButtonColor: '#2563eb'
                            }).then(() => {
                                cargarMarcasSimple(); // 🔥 RECARGAR AUTOMÁTICAMENTE
                            });
                        } else {
                            debugLog('ERROR: No se pudo eliminar la marca');
                            Swal.fire({
                                title: 'Error',
                                text: 'No se pudo eliminar la marca',
                                icon: 'error',
                                confirmButtonColor: '#2563eb'
                            });
                        }
                    },
                    error: function (xhr, status, error) {
                        debugLog('ERROR AJAX al eliminar:', error);
                        showLoading(false);
                        Swal.fire({
                            title: 'Error',
                            text: 'Error de conexión al eliminar',
                            icon: 'error',
                            confirmButtonColor: '#2563eb'
                        });
                    }
                });
            }
        });
    }

    function limpiarModal() {
        debugLog('Limpiando modal...');
        $('#txtIdMarca').val('0');
        $('#txtDescripcion').val('');
        $('#selectEstatus').val('true');
        $('#fileImagen').val('');
        $('#previewImg').hide();
        $('#noImageText').show();
        debugLog('Modal limpiado');
    }

    function showLoading(show) {
        if (show) {
            $('#loadingOverlay').css('display', 'flex');
        } else {
            $('#loadingOverlay').hide();
        }
    }

    function testConexion() {
        debugLog('Probando conexión...');
        showLoading(true);

        $.ajax({
            url: '@Url.Action("ConsultaMarcas", "Marcas")',
            type: 'GET',
            success: function (response) {
                showLoading(false);
                debugLog('Test de conexión:', response);

                if (response && response.data) {
                    Swal.fire({
                        title: 'Conexión Exitosa',
                        text: `Se encontraron ${response.data.length} marcas en la base de datos`,
                        icon: 'success',
                        confirmButtonColor: '#2563eb'
                    });
                } else {
                    Swal.fire({
                        title: 'Error de Conexión',
                        text: 'No se pudo obtener datos de marcas',
                        icon: 'error',
                        confirmButtonColor: '#2563eb'
                    });
                }
            },
            error: function (xhr, status, error) {
                showLoading(false);
                debugLog('ERROR en test de conexión:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Error al probar la conexión: ' + error,
                    icon: 'error',
                    confirmButtonColor: '#2563eb'
                });
            }
        });
    }

    function toggleDebug() {
        debugMode = !debugMode;
        let panel = $('#debugPanel');

        if (debugMode) {
            panel.show();
            debugLog('Debug mode activado');
        } else {
            panel.hide();
            debugLog('Debug mode desactivado');
        }
    }

    function debugLog(message, data = null) {
        let timestamp = new Date().toLocaleTimeString();
        let logMessage = `[${timestamp}] ${message}`;

        console.log(logMessage, data || '');

        if (debugMode) {
            let debugContent = $('#debugContent');
            let currentContent = debugContent.html();
            let newLine = `<div>${logMessage}${data ? ' - ' + JSON.stringify(data) : ''}</div>`;
            debugContent.html(newLine + currentContent);

            // Mantener solo las últimas 20 líneas
            let lines = debugContent.children();
            if (lines.length > 20) {
                lines.slice(20).remove();
            }
        }
    }

    // Funciones globales para debugging
    window.cargarMarcasSimple = cargarMarcasSimple;
    window.editarMarca = editarMarca;
    window.eliminarMarca = eliminarMarca;
    window.testConexion = testConexion;
    window.toggleDebug = toggleDebug;
    window.probarURLDirecta = probarURLDirecta;
    window.cargarDatosEnTabla = cargarDatosEnTabla;

    window.verificarDatos = function () {
        debugLog('Verificando datos en la tabla...');
        $.ajax({
            url: '@Url.Action("ConsultaMarcas", "Marcas")',
            type: 'GET',
            success: function (response) {
                debugLog('Datos actuales:', response);
                console.table(response.data);
            },
            error: function (xhr, status, error) {
                debugLog('ERROR al verificar datos:', error);
            }
        });
    };

    console.log('✅ Script de marcas cargado completamente - SIN DataTables');
</script>